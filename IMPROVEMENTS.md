# IDEF0-SVG Improvements / Улучшения IDEF0-SVG

## New Features / Новые возможности

### 1. Text Background for Better Readability / Фон текста для лучшей читаемости

**EN:** All text labels now have a white background rectangle to prevent text from overlapping with arrows and lines, making diagrams more readable.

**RU:** Все текстовые метки теперь имеют белый прямоугольный фон, чтобы предотвратить наложение текста на стрелки и линии, что делает диаграммы более читаемыми.

**Technical Details:**
- Added 4px padding around text labels
- White background rectangle rendered before text
- Automatically calculated based on text length and position

**Implementation:**
- Modified `lib/idef0/labels.rb` to add background rectangles
- Background color matches diagram background (white)

**Example:**
```xml
<rect x='23' y='183' width='70' height='24' fill='white' stroke='none' />
<text text-anchor='start' x='25' y='205'>Input Data</text>
```

---

### 2. Box Numbering Support / Поддержка нумерации блоков

**EN:** Boxes can now be numbered according to IDEF0 standard by adding a number prefix in square brackets (e.g., `[A1]`, `[A21]`, `[A0]`). The number is displayed in the bottom-right corner of the box, while the name is shown in the center without the prefix.

**RU:** Блоки теперь могут быть пронумерованы в соответствии со стандартом IDEF0 путем добавления номера в квадратных скобках (например, `[A1]`, `[A21]`, `[A0]`). Номер отображается в правом нижнем углу блока, а название показывается в центре без префикса.

**Usage / Использование:**

```idef0
[A0] Main Process receives Input Data
[A0] Main Process respects Policy
[A0] Main Process produces Output Data

[A1] Subprocess One receives Input Data
[A1] Subprocess One produces Intermediate Result

[A2] Subprocess Two receives Intermediate Result
[A2] Subprocess Two produces Output Data
```

**Visual Result / Визуальный результат:**
- Box displays "Main Process" (center, regular size)
- Number "A0" appears in bottom-right corner (smaller font, 10px)
- Box width calculated based on display name only (without number prefix)

**Technical Details:**
- Numbers extracted via regex: `/^\[([^\]]+)\]/`
- Display name generated by removing prefix: `gsub(/^\[([^\]]+)\]\s*/, '')`
- Number positioned at `x2-5, y2-5` with `font-size='10'`

**Implementation:**
- Modified `lib/idef0/process_box.rb`:
  - Added `extract_number` method
  - Added `display_name` method
  - Updated `to_svg` to render number separately
  - Updated `width` calculation to use display name

**Standard Compliance / Соответствие стандарту:**

IDEF0 numbering convention:
- `A0` - Top level/context diagram
- `A1`, `A2`, `A3` - First level decomposition
- `A11`, `A12`, `A21` - Second level decomposition
- Can use any alphanumeric string: `[A21]`, `[B3]`, `[PROC-1]`

---

### 3. Improved Label Positioning / Улучшенное позиционирование меток

**EN:** Label positioning has been improved to reduce overlapping with arrows and improve readability. Offsets have been increased and adjusted for different line types.

**RU:** Позиционирование меток было улучшено для уменьшения наложения на стрелки и улучшения читаемости. Смещения увеличены и скорректированы для различных типов линий.

**Changes / Изменения:**

| Line Type | Old Offset | New Offset | Label Type |
|-----------|-----------|-----------|------------|
| External Guidance | `y1+20-5` | `y1+25` | Centered |
| External Mechanism | `y1-5` | `y1-10` | Centered |
| External Input | `x1+5, y1-5` | `x1+8, y1-8` | Left-aligned |
| External Output | `x2-5, y2-5` | `x2-8, y2-8` | Right-aligned |

**Benefits / Преимущества:**
- Less text-arrow overlap
- Better visual separation
- Combined with white backgrounds for maximum readability

---

## Modified Files / Измененные файлы

### Core Changes / Основные изменения

1. **`lib/idef0/labels.rb`**
   - Added white background rectangles for all labels
   - Increased padding from 2px to 4px
   - Improved `to_svg` method

2. **`lib/idef0/process_box.rb`**
   - Added box numbering support
   - New methods: `extract_number`, `display_name`
   - Modified `to_svg` to render numbers in bottom-right corner
   - Modified `width` calculation to use display name

3. **`lib/idef0/external_guidance_line.rb`**
   - Improved label positioning (y offset)

4. **`lib/idef0/external_mechanism_line.rb`**
   - Improved label positioning (y offset)

5. **`lib/idef0/external_input_line.rb`**
   - Improved label positioning (x and y offsets)

6. **`lib/idef0/external_output_line.rb`**
   - Improved label positioning (x and y offsets)

---

## Testing / Тестирование

Test the improvements with:

```bash
# Test with numbered boxes
bin/schematic < samples/numbered-example.idef0 > output.svg

# Test with cook pizza example (has [A1] prefixes)
bin/schematic < samples/cook-pizza.idef0 > output.svg

# Test with branching (shows improved backgrounds)
bin/schematic < samples/branching-test.idef0 > output.svg
```

---

## Backward Compatibility / Обратная совместимость

**EN:** All improvements are backward compatible:
- Boxes without number prefixes render normally
- Existing diagrams work without changes
- Only visual improvements, no breaking changes to DSL syntax

**RU:** Все улучшения обратно совместимы:
- Блоки без номеров в префиксе отображаются нормально
- Существующие диаграммы работают без изменений
- Только визуальные улучшения, нет критических изменений в синтаксисе DSL

---

## Examples / Примеры

### Without Numbering / Без нумерации
```idef0
Cook Pizza receives Ingredients
Cook Pizza produces Pizza
```
Result: Standard box with "Cook Pizza" centered

### With Numbering / С нумерацией
```idef0
[A1] Cook Pizza receives Ingredients
[A1] Cook Pizza produces Pizza
```
Result: Box with "Cook Pizza" centered + "A1" in bottom-right corner

### Multiple Levels / Несколько уровней
```idef0
[A0] Main Process receives Input
[A1] Subprocess One receives Input
[A2] Subprocess Two receives Data
[A21] Sub-subprocess receives Details
```

---

## Future Improvements / Будущие улучшения

**Potential enhancements:**
- Automatic collision detection for labels
- Dynamic label positioning based on available space
- Configurable background colors
- Optional numbering position (top-left, top-right, etc.)
- Export numbering scheme to separate file

**Возможные улучшения:**
- Автоматическое определение коллизий для меток
- Динамическое позиционирование меток на основе доступного пространства
- Настраиваемые цвета фона
- Опциональная позиция нумерации (вверху слева, вверху справа и т.д.)
- Экспорт схемы нумерации в отдельный файл